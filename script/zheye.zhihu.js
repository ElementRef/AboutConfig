// 2025/12/3 22:55:34 https://raw.githubusercontent.com/ElementRef/AboutConfig/main/script/zheye.zhihu.js
const blockedUsersKey="zhihu_blocked_users",currentUserInfoKey="zhihu_current_userinfo",keywordBlockKey="zhihu_keyword_block",blackAnswersIdKey="zhihu_black_answers";const defaultAnswerBlockedUsers=["\u4F1A\u5458\u63A8\u8350","\u76D0\u9009\u63A8\u8350"];const $=MagicJS("\u54F2\u4E5F\u540C\u5B66","INFO"),testUrl=e=>new RegExp(e).test($.request.url);function getUserInfo(){const e={id:"default",is_vip:!1};try{const{id:t=e.id,is_vip:r=e.is_vip}=$.data.read(currentUserInfoKey,{});return{id:t,is_vip:r}}catch(t){return $.logger.error(`\u83B7\u53D6\u7528\u6237\u4FE1\u606F\u51FA\u73B0\u5F02\u5E38\uFF1A${t}`),e}}function modifyAppTabConfig(){try{if($.data.read("zhihu_settings_app_conf",!1)===!1)return null;const e=JSON.parse($.response.body),t=["follow","recommend","hot"];return e.tab_list=e.tab_list?.filter((r=>t.includes(r.tab_type)))||[],$.logger.debug(`\u4FEE\u6539\u63A8\u8350\u9875Tab\uFF1A${JSON.stringify(e)}`),{body:JSON.stringify(e)}}catch(e){$.logger.error(`\u79FB\u9664\u63A8\u8350\u9875Tab\u51FA\u73B0\u5F02\u5E38\uFF1A${e}`)}}function unlockBlockedKeywords(){const e=(t,r)=>{const s={"Cache-Control":"no-cache, no-store, must-revalidate, private, max-age=0",Connection:"keep-alive","Content-Type":"application/json;charset=utf-8",Pragma:"no-cache","Referrer-Policy":"no-referrer-when-downgrade",Server:"CLOUD ELB 1.0.0",Vary:"Accept-Encoding","X-Cache-Lookup":"Cache Miss","x-cdn-provider":"tencent"};return $.env.isQuanX?{body:t,headers:s,status:r}:{response:{body:t,headers:s,status:{"HTTP/1.1 200 OK":200,"HTTP/1.1 400 Bad Request":400}[r]}}};try{if($.data.read("zhihu_settings_blocked_keywords",!0)===!1)return null;const t=getUserInfo(),r=$.data.read(keywordBlockKey,null,t.id)||[];let s=decodeURIComponent($.request.body).match(/keyword=(.*)/),u=s?s[1]:"";if($.logger.debug(`\u51C6\u5907\u64CD\u4F5C\u672C\u5730\u5173\u952E\u8BCD\uFF1A${u}`),$.request.method==="GET"){const c=JSON.stringify({success:!0,is_vip:!0,kw_min_length:2,kw_max_length:100,kw_max_count:1e3,data:r});return $.logger.debug(`\u83B7\u53D6\u672C\u5730\u811A\u672C\u5C4F\u853D\u5173\u952E\u8BCD\uFF1A
${r.join("\u3001")}`),e(c,"HTTP/1.1 200 OK")}if($.request.method==="POST"){if(r.includes(u))return e(JSON.stringify({error:{message:"\u5173\u952E\u8BCD\u5DF2\u5B58\u5728",code:100002}}),"HTTP/1.1 400 Bad Request");r.push(u),$.data.write(keywordBlockKey,r,t.id);const c=JSON.stringify({success:!0});return $.logger.debug(`\u6DFB\u52A0\u672C\u5730\u811A\u672C\u5C4F\u853D\u5173\u952E\u8BCD\u201C${u}\u201D`),e(c,"HTTP/1.1 200 OK")}if($.request.method==="DELETE"){s=decodeURIComponent($.request.url).match(/keyword=(.*)/),u=s?s[1]:"";const c=r.filter((g=>g!==u));$.data.write(keywordBlockKey,c,t.id);const p=JSON.stringify({success:!0});return $.logger.debug(`\u5220\u9664\u672C\u5730\u811A\u672C\u5C4F\u853D\u5173\u952E\u8BCD\uFF1A\u201C${u}\u201D`),e(p,"HTTP/1.1 200 OK")}}catch(t){$.logger.error(`\u5173\u952E\u8BCD\u5C4F\u853D\u64CD\u4F5C\u51FA\u73B0\u5F02\u5E38\uFF1A${t}`)}}function processUserInfo(){try{const e=JSON.parse($.response.body);if($.data.write(blackAnswersIdKey,[]),!e?.id||e?.vip_info?.is_vip===void 0)return $.logger.warning("\u6CA1\u6709\u83B7\u53D6\u5230\u672C\u6B21\u767B\u5F55\u7528\u6237\u4FE1\u606F\uFF0C\u5982\u672A\u5BF9\u529F\u80FD\u9020\u6210\u5F71\u54CD\uFF0C\u8BF7\u5FFD\u7565\u6B64\u65E5\u5FD7\u3002"),null;{const t={id:e.id,is_vip:e.vip_info.is_vip??!1};if($.data.write(currentUserInfoKey,t),$.data.read("zhihu_settings_blocked_keywords")!==!1&&e.vip_info.is_vip===!1)return e.vip_info.is_vip=!0,e.vip_info.vip_type=2,e.vip_info.vip_icon={url:"https://picx.zhimg.com/v2-aa8a1823abfc46f14136f01d55224925.jpg?source=88ceefae",night_mode_url:"https://picx.zhimg.com/v2-aa8a1823abfc46f14136f01d55224925.jpg?source=88ceefae"},{body:JSON.stringify(e)}}}catch(e){return $.logger.error(`\u83B7\u53D6\u5F53\u524D\u7528\u6237\u4FE1\u606F\u51FA\u73B0\u5F02\u5E38\uFF1A${e}`),null}}function manageBlackUser(){const e=getUserInfo();let t={},r=$.data.read(blockedUsersKey,"",e.id);r=typeof r=="object"?r:{},defaultAnswerBlockedUsers.forEach((s=>{r[s]=t[s]="00000000000000000000000000000000"})),$.logger.debug(`\u5F53\u524D\u7528\u6237id\uFF1A${e.id}\uFF0C\u811A\u672C\u9ED1\u540D\u5355\uFF1A${JSON.stringify(r)}`);try{if($.request.method==="GET"){$.request.url.includes("offset")||(r=t,$.logger.debug("\u811A\u672C\u9ED1\u540D\u5355\u5DF2\u6E05\u7A7A\uFF0C\u8BF7\u6ED1\u52A8\u81F3\u9ED1\u540D\u5355\u672B\u5C3E\u4FDD\u8BC1\u91CD\u65B0\u83B7\u53D6\u5B8C\u6210\u3002"),$.notification.post("\u5F00\u59CB\u540C\u6B65\u9ED1\u540D\u5355\u6570\u636E\uFF0C\u8BF7\u6ED1\u52A8\u81F3\u9ED1\u540D\u5355\u672B\u5C3E\uFF0C\u76F4\u81F3\u5F39\u51FA\u201C\u540C\u6B65\u6210\u529F\u201D\u7684\u901A\u77E5\u3002"));let s=JSON.parse($.response.body);s?.data?.forEach((({name:u,id:c})=>{u!=="[\u5DF2\u91CD\u7F6E]"&&u&&c&&(r[u]=c)})),$.data.write(blockedUsersKey,r,e.id),s?.paging?.is_end&&($.notification.post(`\u540C\u6B65\u9ED1\u540D\u5355\u6570\u636E\u6210\u529F\uFF01\u5F53\u524D\u9ED1\u540D\u5355\u5171${Object.keys(r).length-defaultAnswerBlockedUsers.length}\u4EBA\u3002
\u811A\u672C\u5185\u7F6E\u9ED1\u540D\u5355${defaultAnswerBlockedUsers.length}\u4EBA\u3002`),$.logger.debug(`\u811A\u672C\u9ED1\u540D\u5355\u5185\u5BB9\uFF1A${JSON.stringify(r)}\u3002`))}else if($.request.method==="POST"){let{name:s,id:u}=JSON.parse($.response.body);s&&u&&(r[s]=u,$.data.write(blockedUsersKey,r,e.id),$.logger.debug(`${s}\u5199\u5165\u811A\u672C\u9ED1\u540D\u5355\u6210\u529F\uFF0C\u5F53\u524D\u811A\u672C\u9ED1\u540D\u5355\u6570\u636E\uFF1A${JSON.stringify(r)}`),$.notification.post(`\u5DF2\u5C06\u7528\u6237\u201C${s}\u201D\u5199\u5165\u811A\u672C\u9ED1\u540D\u5355\u3002`))}else if($.request.method==="DELETE"&&JSON.parse($.response.body).success){let s=$.request.url.match(/^https:\/\/api\.zhihu\.com\/settings\/blocked_users\/([0-9a-zA-Z]*)/)[1];if(s){for(let u in r)if(r[u]===s){delete r[u],$.data.write(blockedUsersKey,r,e.id),$.logger.debug(`${u}\u79FB\u51FA\u811A\u672C\u9ED1\u540D\u5355\u6210\u529F\uFF0C\u5F53\u524D\u811A\u672C\u9ED1\u540D\u5355\u6570\u636E\uFF1A${JSON.stringify(r)}`),$.notification.post(`\u5DF2\u5C06\u7528\u6237\u201C${u}\u201D\u79FB\u51FA\u811A\u672C\u9ED1\u540D\u5355\uFF01`);break}}}}catch(s){$.logger.error(`\u64CD\u4F5C\u9ED1\u540D\u5355\u5931\u8D25\uFF0C\u5F02\u5E38\u4FE1\u606F\uFF1A${s}`),$.notification.post("\u64CD\u4F5C\u9ED1\u540D\u5355\u5931\u8D25\uFF0C\u6267\u884C\u5F02\u5E38\uFF0C\u8BF7\u67E5\u9605\u65E5\u5FD7\u3002")}}function autoInsertBlackList(){try{if($.data.read("zhihu_settings_blocked_users",!0)===!1)return null;const e=JSON.parse($.response.body);if(e.name&&e.id&&e.is_blocking===!0){const t=getUserInfo();let r=$.data.read(blockedUsersKey,"",t.id);r=(typeof r=="object"&&r)??{},r[e.name]||($.logger.debug(`\u5F53\u524D\u9700\u8981\u52A0\u5165\u9ED1\u540D\u5355\u7684\u7528\u6237Id\uFF1A${e.id}\uFF0C\u7528\u6237\u540D\uFF1A${e.name}`),r[e.name]=e.id,$.data.write(blockedUsersKey,r,t.id),$.logger.debug(`${e.name}\u5199\u5165\u811A\u672C\u9ED1\u540D\u5355\u6210\u529F\uFF0C\u5F53\u524D\u811A\u672C\u9ED1\u540D\u5355\u6570\u636E\uFF1A${JSON.stringify(r)}`),$.notification.post(`\u5DF2\u81EA\u52A8\u5C06\u7528\u6237\u201C${e.name}\u201D\u5199\u5165\u811A\u672C\u9ED1\u540D\u5355\u3002`))}return{body:JSON.stringify(e)}}catch(e){$.logger.error(`\u53BB\u9664MCN\u4FE1\u606F\u51FA\u73B0\u5F02\u5E38\uFF1A${e}`)}}function removeMoments(){try{const e=$.data.read("zhihu_settings_blocked_users",!1);if(e===!1)return null;let t=JSON.parse($.response?.body||"{}");const r=getUserInfo();let s={};return s=$.data.read(blockedUsersKey,{},r.id)||{},t.data=t.data?.filter((u=>{const c=u.target?.author;return!(e&&c&&s.hasOwnProperty(c))}))||[],{body:JSON.stringify(t)}}catch(e){$.logger.error(`\u5173\u6CE8\u5217\u8868\u53BB\u5E7F\u544A\u51FA\u73B0\u5F02\u5E38\uFF1A${e}`)}}function getAllTagConfigs(){let e={};try{const t=$.data.read("zhihu_settings_custom_tags","");$.logger.debug(`\u81EA\u5B9A\u4E49\u6807\u7B7E\u914D\u7F6E\uFF1A${t}`),e=t.split(";").filter((s=>s.trim()!=="")).map((s=>s.split(":"))).reduce(((s,u)=>(u.length!==2?$.logger.error(`\u81EA\u5B9A\u4E49\u6807\u7B7E\u914D\u7F6E\u9519\u8BEF\uFF1A${u.join(":")}`):s[u[0]]=u[1],s)),{});const r={\u4ED8\u8D39\u5185\u5BB9:"\u67E5\u770B\u5B8C\u6574\u5185\u5BB9|\u67E5\u770B\u5168\u90E8\u7AE0\u8282",\u8425\u9500\u63A8\u5E7F:"ad-link-card|xg.zhihu.com|\u8425\u9500\u5E73\u53F0",\u8D2D\u7269\u63A8\u5E7F:"mcn-link-card",...e};return $.logger.debug(`\u5408\u5E76\u540E\u7684\u6807\u7B7E\u914D\u7F6E\uFF1A${JSON.stringify(r)}`),r}catch(t){$.notification.post("\u63A8\u8350\u9875\u8BBE\u7F6E\u81EA\u5B9A\u4E49\u6807\u7B7E\u51FA\u73B0\u5F02\u5E38\uFF0C\u8BF7\u68C0\u67E5\u6807\u7B7E\u914D\u7F6E"),$.logger.error(`\u63A8\u8350\u9875\u8BBE\u7F6E\u81EA\u5B9A\u4E49\u6807\u7B7E\u51FA\u73B0\u5F02\u5E38\uFF0C\u8BF7\u68C0\u67E5\u6807\u7B7E\u914D\u7F6E\uFF1A${t}`)}return e}async function removeRecommend(){if(!$.response.body)return $.logger.error("\u63A8\u8350\u5217\u9875\u53BB\u5E7F\u544A\u65E0\u6CD5\u83B7\u53D6\u54CD\u5E94\u4F53"),null;try{const e={recommend_stream:$.data.read("zhihu_settings_recommend_stream",!1),remove_article:$.data.read("zhihu_settings_remove_article",!1),remove_advertorial:$.data.read("zhihu_settings_remove_advertorial",!0),remove_pin:$.data.read("zhihu_settings_remove_pin",!0),blocked_users:$.data.read("zhihu_settings_blocked_users",!1),blocked_keywords:$.data.read("zhihu_settings_blocked_keywords",!0),check_paid_content:$.data.read("zhihu_settings_check_paid_content",!1),request_content:$.data.read("zhihu_settings_request_content","local")},t=getUserInfo(),r=e.blocked_keywords&&$.data.read(keywordBlockKey,"",t.id)||[],s=e.blocked_users&&$.data.read(blockedUsersKey,"",t.id)||{},u=$.response.body instanceof Uint8Array?new TextDecoder().decode($.response.body):$.response.body,c=JSON.parse(u);if(c.data=c.data.filter((p=>!isFiltered(p,JSON.stringify(p),e,r,s))),c.fresh_text){const p=parseInt((c.fresh_text.match(/\d+/)||["0"])[0]);c.fresh_text=p>0?`\u5237\u65B0 ${p} \u6761\u5185\u5BB9\uFF0C\u8FC7\u6EE4\u540E\u5269\u4F59 ${c.data.length} \u6761`:`\u8FC7\u6EE4\u540E\u5269\u4F59 ${c.data.length} \u6761`}return{body:JSON.stringify(c)}}catch(e){return $.logger.error(`\u63A8\u8350\u5217\u8868\u53BB\u5E7F\u544A\u51FA\u73B0\u5F02\u5E38\uFF1A${e}`),null}}function isFiltered(e,t,r,s,u){if(e.type==="market_card"||e.type==="feed_advert"||e.extra?.type==="SvipActivity"||t.includes("\u76D0\u9009\u63A8\u8350")||e.hasOwnProperty("ad"))return $.logger.debug(`${t}\u5339\u914D\u5230\u5E7F\u544A`),!0;if(r.remove_advertorial&&(e.hasOwnProperty("promotion_extra")||t.includes(" \xB7 \u5546\u54C1\u4ECB\u7ECD")))return $.logger.debug(`${t}\u5339\u914D\u5230\u8F6F\u6587`),!0;if(r.remove_article&&t.search(/"type"\s*:\s*"article"/i)>=0)return $.logger.debug(`${t}\u5339\u914D\u5230\u6587\u7AE0`),!0;if(r.recommend_stream&&t.search(/"(type|style|content_type)"\s*:\s*"(zvideo|BIG_IMAGE|drama|StyleVideo)"/i)>=0)return $.logger.debug(`${t}\u5339\u914D\u5230\u6D41\u5A92\u4F53`),!0;if(r.remove_pin&&t.search(/type"\s*:\s*"pin"/i)>=0)return $.logger.debug(`${t}\u5339\u914D\u5230\u60F3\u6CD5`),!0;if(r.blocked_keywords&&s.length>0&&s.some((c=>{const p=t.search(c)>=0;if(p&&$.isDebug&&Array.isArray(e.children)){const g=e.children.find((f=>f.id==="Text"))?.text,l=e.children.find((f=>f.id==="text_pin_summary"))?.text;$.logger.debug(`\u5339\u914D\u5173\u952E\u5B57\uFF1A
${c}
\u6807\u9898\uFF1A
${g}
\u5185\u5BB9\uFF1A
${l}`)}return p})))return!0;if(r.blocked_users&&Object.keys(u).length>0){const c=e.children?.find((p=>p.type==="Line"&&p.style==="LineAuthor_default"))?.elements.find((p=>p.type==="Text"))?.text||"";if(u.hasOwnProperty(c))return!0}return!1}function removeQuestions(){try{let e=JSON.parse($.response.body);delete e.ad_info;const t=getUserInfo();let r=$.data.read(blockedUsersKey,"",t.id)||{};const s=$.data.read("zhihu_settings_blocked_users",!1);$.logger.debug(`\u5F53\u524D\u9ED1\u540D\u5355\u5217\u8868: ${JSON.stringify(r)}`);let u=$.data.read(blackAnswersIdKey,[])||[];e?.data&&(e.data=e.data.filter((p=>{const{target:g,target:{id:l="",author:{name:f=""}={}}={}}=p,n=r.hasOwnProperty(f),i=s&&n;return g&&(p.target.visible_only_to_author=!1,p.target.is_visible=!0,p.target.is_copyable=!0),i&&!u.includes(l.toString())&&(u.push(l.toString()),$.notification.debug(`\u8BB0\u5F55\u9ED1\u540D\u5355\u7528\u6237${f}\u7684\u56DE\u7B54Id:${l}`)),!i}))),$.data.write(blackAnswersIdKey,u);const c=JSON.stringify(e);return $.logger.debug(`\u4FEE\u6539\u540E\u7684\u56DE\u7B54\u5217\u8868\u6570\u636E\uFF1A${c}`),{body:c}}catch(e){$.logger.error(`\u56DE\u7B54\u5217\u8868\u53BB\u5E7F\u544A\u51FA\u73B0\u5F02\u5E38\uFF1A${e}`)}}function insertContentTip(){const e=JSON.parse($.response.body??"{}"),t=getAllTagConfigs();if(e?.endorsement){for(const[r,s]of Object.entries(t))if($.logger.debug(`\u68C0\u6D4B\u5185\u5BB9\uFF1A${s}\uFF0C\u6807\u7B7E\uFF1A${r}`),typeof s=="string"&&new RegExp(s).test($.response.body)){$.logger.debug(`\u5185\u5BB9\uFF1A
 ${$.response.body}
\u5339\u914D\u5230\u6807\u7B7E\uFF1A
${r}`);const u={action_url:"https://github.com/blackmatrix7/ios_rule_script/tree/master/script/zheye",background_color:{alpha:.1,group:"GBL01A"},elements:[{content:r,font_color:{alpha:1,group:"GBL07A"},font_size:13,is_bold:!0,max_line:1,type:"TEXT"}],sub_elements:[],sub_elements_type:"DESCRIPTION",za:{block_text:"ThanksForInvitingLabel",text:"",type:"text"}};e.endorsement.unshift(u);break}}else if(e?.content_card_list){for(const[r,s]of Object.entries(t))if($.logger.debug(`\u68C0\u6D4B\u5185\u5BB9\uFF1A${s}\uFF0C\u6807\u7B7E\uFF1A${r}`),typeof s=="string"&&new RegExp(s).test($.response.body)){$.logger.debug(`\u5185\u5BB9\uFF1A
 ${$.response.body}
\u5339\u914D\u5230\u6807\u7B7E\uFF1A
${r}`);const u={card_type:"km-paid-answer-header",dynamic_id:":km-sku-card-head",extra_info:`{"title_line":
                          {"scene":"ANSWER_DETAIL",
                           "copyright":"${r}",
                           "style":"v2",
                           "content_type":"ANSWER"
                         }`};e.content_card_list.unshift(u);break}}return e}function removeComment(){try{const e=$.response?.body;if(!e)return null;let t=JSON.parse(e);if(t.ad_info={},!$.data.read("zhihu_settings_blocked_users",!1))return{body:JSON.stringify(t)};const{id:r}=getUserInfo(),s=$.data.read(blockedUsersKey,{},r)||{},u=g=>{g.is_delete=!0,g.can_reply=!1,g.can_like=!1,g.author.name="[\u9ED1\u540D\u5355\u7528\u6237]",g.author.avatar_url="https://picx.zhimg.com/v2-abed1a8c04700ba7d72b45195223e0ff_xll.jpg",g.author.exposed_medal={}},c=g=>{g.name="[\u9ED1\u540D\u5355\u7528\u6237]",g.avatar_url="https://picx.zhimg.com/v2-abed1a8c04700ba7d72b45195223e0ff_xll.jpg",g.exposed_medal={}},p=g=>g.map((l=>{const{name:f}=l.author,n=l.reply_to_author?.name||"",i=s[f],d=s[n];return(i||d)&&(i&&u(l),d&&c(l.reply_to_author)),l.child_comments&&(l.child_comments=p(l.child_comments)),l}));if(t.root){const{name:g}=t.root.author;s[g]&&u(t.root)}return t.data&&(t.data=p(t.data)),{body:JSON.stringify(t)}}catch(e){$.logger.error(`\u53BB\u9664\u8BC4\u8BBA\u5E7F\u544A\u51FA\u73B0\u5F02\u5E38\uFF1A${e}`)}}function removeMarketingMsg(){try{if($.data.read("zhihu_settings_marketing_msg",!0)===!1)return null;const e=JSON.parse($.response?.body||"{}");e?.column_head?.forEach((r=>{r?.id==="column_head_entry_invite"&&(r.text=`\u60A8\u6709${r.unread_count}\u6761\u65B0\u7684\u9080\u8BF7\u56DE\u7B54`,r.unread_count=0)}));const t=["\u8D85\u8D5E\u5305\u5C0F\u52A9\u624B","\u77E5\u4E4E\u6D3B\u52A8\u52A9\u624B","\u8003\u7814\u8BB0\u4E8B\u672C","\u521B\u4F5C\u8005\u5C0F\u52A9\u624B"];return e.data=e?.data?.reduce(((r,s)=>{const u=s?.content?.title||s?.detail_title;if(u==="\u5B98\u65B9\u8D26\u53F7\u6D88\u606F"){const c=s?.unread_count||0;s.content.text=c>0?`\u672A\u8BFB\u6D88\u606F${c}\u6761`:"\u5168\u90E8\u6D88\u606F\u5DF2\u8BFB",s.is_read=!0,s.unread_count=0}return t.includes(u)||r.push(s),r}),[])||[],{body:JSON.stringify(e)}}catch(e){return $.logger.error(`\u5C4F\u853D\u5B98\u65B9\u8425\u9500\u6D88\u606F\u51FA\u73B0\u5F02\u5E38\uFF1A${e}`),null}}function removeHotListAds(){let e=null;try{if($.data.read("zhihu_settings_hot_list",!0)===!1)return null;if($.response.body){let t=JSON.parse($.response.body);"data"in t&&(t.data=t.data.filter((r=>r.type==="hot_list_feed"||r.type==="hot_list_feed_video"))),e={body:JSON.stringify(t)}}}catch(t){$.logger.error(`\u53BB\u9664\u70ED\u699C\u5E7F\u544A\u51FA\u73B0\u5F02\u5E38\uFF1A${t}`)}return e}function removeKeywordAds(){try{if($.data.read("zhihu_settings_preset_words",!0)===!1)return null;const e=$.response?.body;if(!e)return null;const t=JSON.parse(e),r=t?.preset_words?.words;return r?(t.preset_words.words=r.filter((s=>s.type==="general")),{body:JSON.stringify(t)}):null}catch(e){return $.logger.error(`\u53BB\u9664\u9884\u7F6E\u5173\u952E\u5B57\u5E7F\u544A\u5F02\u5E38\uFF1A${e}`),null}}function removeQueryAds(){try{const e=$.response?.body;if(!e)return null;const t=JSON.parse(e);return t?.recommend_queries?.queries?(t.recommend_queries.queries=t.recommend_queries.queries.filter((r=>!r.hasOwnProperty("ad_commercial_json"))),{body:JSON.stringify(t)}):null}catch(e){return $.logger.error(`\u53BB\u9664\u731C\u4F60\u60F3\u641C\u5E7F\u544A\u5F02\u5E38\uFF1A${e}`),null}}function modifyAnswersNextRender(){try{const e=$.response?.body;if(!e)return null;const t=JSON.parse(e),r=getUserInfo(),s=$.data.read("zhihu_settings_blocked_users",!1);let u={};return s&&(u=$.data.read(blockedUsersKey,{},r.id)||{},$.logger.debug(`\u811A\u672C\u9ED1\u540D\u5355\u7528\u6237\uFF1A
${JSON.stringify(u)}`)),t.data=t.data.filter((c=>{const{ad_info:p={},biz_type_list:g=[],type:l="",adjson:f="",author:{fullname:n}={}}=c||{},i=p?.data||g?.length!==1||g?.[0]!=="answer"||l==="ad"||f,d=s&&u.hasOwnProperty(n);return $.logger.debug(`\u7528\u6237${n}\u662F\u5426\u5728\u9ED1\u540D\u5355\u4E2D\uFF1A${d}`),!(i||s&&d)})),{body:JSON.stringify(t)}}catch(e){$.logger.error(`\u5C4F\u853D\u56DE\u7B54\u4FE1\u606F\u6D41\u9ED1\u540D\u5355\u7528\u6237\u53CA\u5E7F\u544A\uFF1A${e}`)}}function removeAnswerOrArticleAd(){$.logger.debug("\u5F00\u59CB\u79FB\u9664\u56DE\u7B54\u9875\u5E7F\u544A");try{const e=insertContentTip();return delete e.third_business,$.logger.debug(JSON.stringify(e)),{body:JSON.stringify(e)}}catch(e){return $.logger.error(`\u79FB\u9664\u56DE\u7B54\u9875\u5E7F\u544A\u51FA\u73B0\u5F02\u5E38\uFF1A${e}`),null}}function AsyncFunction(){return Object.prototype.toString.call(this)==="[object AsyncFunction]"}const urlHandlers={resp_handlers:{"^https:\\/\\/api\\.zhihu\\.com\\/people\\/self$":processUserInfo,"^https:\\/\\/api\\.zhihu\\.com\\/root\\/tab\\/v2":modifyAppTabConfig,"^https:\\/\\/(api|web-render)\\.zhihu\\.com\\/topstory\\/recommend":removeRecommend,"^https:\\/\\/api\\.zhihu\\.com\\/questions\\/\\d+\\/feeds":removeQuestions,"^https:\\/\\/api\\.zhihu\\.com\\/next-render\\?":modifyAnswersNextRender,"^https:\\/\\/api\\.zhihu\\.com\\/notifications\\/v3\\/message":removeMarketingMsg,"^https:\\/\\/api\\.zhihu\\.com\\/comment_v5\\/(answers|pins|comments?|articles)\\/\\d+\\/(root|child)_comment":removeComment,"^https:\\/\\/(page-info|api)\\.zhihu\\.com\\/(answers|articles)\\/v2\\/\\d+":removeAnswerOrArticleAd,"^https:\\/\\/api\\.zhihu\\.com\\/articles\\/v\\d\\/\\d+":removeAnswerOrArticleAd,"^https:\\/\\/api\\.zhihu\\.com\\/people\\/\\d+":autoInsertBlackList,"^https:\\/\\/api\\.zhihu\\.com\\/moments_v3\\?":removeMoments,"^https?:\\/\\/api\\.zhihu\\.com\\/topstory\\/hot-lists":removeHotListAds,"^https:\\/\\/api\\.zhihu\\.com\\/search\\/preset_words":removeKeywordAds,"^https:\\/\\/api\\.zhihu\\.com\\/search\\/recommend_query":removeQueryAds,"^https:\\/\\/api\\.zhihu\\.com\\/settings\\/blocked_users":manageBlackUser},req_handlers:{"^https:\\/\\/api\\.zhihu\\.com\\/feed-root\\/block":unlockBlockedKeywords}};async function handleRequest(e){let t=null;for(const r in urlHandlers[e])if($.logger.debug(`\u5F53\u524D\u5904\u7406\u7684URL\uFF1A${$.request.url}\uFF0C\u5339\u914D\u89C4\u5219\uFF1A${r}`),$.logger.debug(`\u5339\u914D\u7ED3\u679C${testUrl(r)}`),testUrl(r)){$.logger.debug(`\u5F53\u524D\u5904\u7406\u7684URL\uFF1A${$.request.url}\uFF0C\u5339\u914D\u89C4\u5219\uFF1A${r}`);const s=urlHandlers[e][r];t=s instanceof AsyncFunction?await s():s();break}return t}function MagicJS(e="MagicJS",t="INFO"){return new class{constructor(r,s){if(this._startTime=Date.now(),this.version="3.0.0",this.scriptName=r,this.env=(()=>{const u=typeof $loon<"u",c=typeof $task<"u",p=typeof module<"u",g=typeof $httpClient<"u"&&!u,l=typeof $storm<"u",f=typeof $environment<"u"&&$environment["stash-build"]!==void 0,n=typeof importModule<"u";return{isLoon:u,isQuanX:c,isNode:p,isSurge:g,isStorm:l,isStash:f,isSurgeLike:g||u||l||f,isScriptable:n,get name(){return u?"Loon":c?"QuantumultX":p?"NodeJS":g?"Surge":n?"Scriptable":"unknown"},get build(){return g?$environment["surge-build"]:f?$environment["stash-build"]:l?$storm.buildVersion:void 0},get language(){if(g||f)return $environment.language},get version(){return g?$environment["surge-version"]:f?$environment["stash-version"]:l?$storm.appVersion:p?process.version:void 0},get system(){return g?$environment.system:p?process.platform:void 0},get systemVersion(){if(l)return $storm.systemVersion},get deviceName(){if(l)return $storm.deviceName}}})(),this.logger=((u,c="INFO")=>{let p=c;const g={SNIFFER:6,DEBUG:5,INFO:4,NOTIFY:3,WARNING:2,ERROR:1,CRITICAL:0,NONE:-1},l={SNIFFER:"",DEBUG:"",INFO:"",NOTIFY:"",WARNING:"\u2757 ",ERROR:"\u274C ",CRITICAL:"\u274C ",NONE:""},f=(n,i="INFO")=>{g[p]<g[i.toUpperCase()]};return{getLevel:()=>p,setLevel:n=>{p=n},sniffer:n=>{f(n,"SNIFFER")},debug:n=>{f(n,"DEBUG")},info:n=>{f(n,"INFO")},notify:n=>{f(n,"NOTIFY")},warning:n=>{f(n,"WARNING")},error:n=>{f(n,"ERROR")},retry:n=>{f(n,"RETRY")}}})(r,s),this.http=typeof MagicHttp=="function"?MagicHttp(this.env,this.logger):void 0,this.data=typeof MagicData=="function"?MagicData(this.env,this.logger):void 0,this.notification=typeof MagicNotification=="function"?MagicNotification(this.scriptName,this.env,this.logger,this.http):void 0,this.utils=typeof MagicUtils=="function"?MagicUtils(this.env,this.logger):void 0,this.qinglong=typeof MagicQingLong=="function"?MagicQingLong(this.env,this.data,this.logger):void 0,this.data!==void 0){let u=this.data.read("magic_loglevel");const c=this.data.read("magic_bark_url");u&&this.logger.setLevel(u.toUpperCase()),c&&this.notification.setBark(c)}}get isRequest(){return typeof $request<"u"&&typeof $response>"u"}get isResponse(){return typeof $response<"u"}get isDebug(){return this.logger.level==="DEBUG"}get request(){return typeof $request<"u"?$request:void 0}get response(){return typeof $response<"u"?($response.hasOwnProperty("status")&&($response.statusCode=$response.status),$response.hasOwnProperty("statusCode")&&($response.status=$response.statusCode),$response):void 0}done=(r={})=>{this._endTime=Date.now();let s=(this._endTime-this._startTime)/1e3;this.logger.debug(`SCRIPT COMPLETED: ${s} S.`),typeof $done<"u"&&$done(r)}}(e,t)}function MagicNotification(e,t,r,s){let u=null,c=null;function p(g=e,l="",f="",n=""){if(s===void 0||s.post===void 0)throw"Bark notification needs to import MagicHttp module.";let i={url:u,headers:{"content-type":"application/json; charset=utf-8"},body:{title:g,body:l?`${l}
${f}`:f,device_key:c}};s.post(i).catch((d=>{r.error(`Bark notify error: ${d}`)}))}return{post:function(g=e,l="",f="",n=""){n=(i=>{try{let d={};if(typeof i=="string")t.isLoon?d={openUrl:i}:t.isQuanX?d={"open-url":i}:t.isSurge&&(d={url:i});else if(typeof i=="object"){if(t.isLoon)d.openUrl=i["open-url"]?i["open-url"]:"",d.mediaUrl=i["media-url"]?i["media-url"]:"";else if(t.isQuanX)d=i["open-url"]||i["media-url"]?i:{};else if(t.isSurge){let h=i["open-url"]||i.openUrl;d=h?{url:h}:{}}}return d}catch(d){r.error(`\u901A\u77E5\u9009\u9879\u8F6C\u6362\u5931\u8D25${d}`)}return i})(n),arguments.length===1&&(g=e,l="",f=arguments[0]),r.notify(`title:${g}
subTitle:${l}
body:${f}
options:${typeof n=="object"?JSON.stringify(n):n}`),t.isSurge?$notification.post(g,l,f,n):t.isLoon?n?$notification.post(g,l,f,n):$notification.post(g,l,f):t.isQuanX&&$notify(g,l,f,n),u&&c&&p(g,l,f)},debug:function(g=e,l="",f="",n=""){r.getLevel()==="DEBUG"&&(arguments.length===1&&(g=e,l="",f=arguments[0]),this.post(g,l,f,n))},bark:p,setBark:g=>{try{let l=g.replace(/\/+$/g,"");u=`${/^https?:\/\/([^/]*)/.exec(l)[0]}/push`,c=/\/([^\/]+)\/?$/.exec(l)[1]}catch(l){r.error(`Bark url error: ${l}.`)}}}}function MagicData(e,t){let r={fs:void 0,data:{}};if(e.isNode){r.fs=require("fs");try{r.fs.accessSync("./magic.json",r.fs.constants.R_OK|r.fs.constants.W_OK)}catch{r.fs.writeFileSync("./magic.json","{}",{encoding:"utf8"})}r.data=require("./magic.json")}const s=(n,i)=>typeof i!="object"&&n===i,u=n=>n==="true"||n!=="false"&&(n===void 0?null:n),c=(n,i,d,h)=>{if(d)try{typeof n=="string"&&(n=JSON.parse(n)),n=n.magic_session===!0?n[d]:null}catch{n=null}if(typeof n=="string"&&n!=="null")try{n=JSON.parse(n)}catch{}return h===!1&&n&&n.magic_session===!0&&(n=null),n==null&&i!=null&&(n=i),n=u(n)},p=n=>{if(typeof n=="string"){let i={};try{i=JSON.parse(n);const d=typeof i;(d!=="object"||i instanceof Array||d==="bool"||i===null)&&(i={})}catch{}return i}return n instanceof Array||n==null||n!=n||typeof n=="boolean"?{}:n},g=(n,i=null,d="",h=!1,o=null)=>{let a=o||r.data;return a&&a[n]!==void 0&&a[n]!==null?val=a[n]:val=d?{}:null,val=c(val,i,d,h),val},l=(n,i=null,d="",h=!1,o=null)=>{let a="";return o||e.isNode?a=g(n,i,d,h,o):(e.isSurgeLike?a=$persistentStore.read(n):e.isQuanX&&(a=$prefs.valueForKey(n)),a=c(a,i,d,h)),t.debug(`READ DATA [${n}]${d?`[${d}]`:""} <${typeof a}>
${JSON.stringify(a)}`),a},f=(n,i,d="",h=null)=>{if(i===void 0||i!=i)return!1;e.isNode||typeof i!="boolean"&&typeof i!="number"||(i=String(i));let o="";if(h||e.isNode?o=((a,_,S="",k=null)=>{let N=k||r.data;if(N=p(N),S){let w=p(N[a]);w.magic_session=!0,w[S]=_,N[a]=w}else N[a]=_;return k!==null&&(k=N),N})(n,i,d,h):d?(e.isSurgeLike?o=$persistentStore.read(n)?$persistentStore.read(n):o:e.isQuanX&&(o=$prefs.valueForKey(n)?$prefs.valueForKey(n):o),o=p(o),o.magic_session=!0,o[d]=i):o=i,o&&typeof o=="object"&&(o=JSON.stringify(o,null,4)),t.debug(`WRITE DATA [${n}]${d?`[${d}]`:""} <${typeof i}>
${JSON.stringify(i)}`),!h){if(e.isSurgeLike)return $persistentStore.write(o,n);if(e.isQuanX)return $prefs.setValueForKey(o,n);if(e.isNode)try{return r.fs.writeFileSync("./magic.json",o),!0}catch(a){return t.error(a),!1}}return!0};return{read:l,write:f,del:(n,i="",d=null)=>{let h={};if(d||e.isNode)h=((o,a,_)=>{let S=_||r.data;return S=p(S),a?(obj=p(S[o]),delete obj[a],S[o]=obj):delete S[o],_&&(_=S),S})(n,i,d),d?d=h:r.fs.writeFileSync("./magic.json",JSON.stringify(h,null,4));else if(i){e.isSurgeLike?h=$persistentStore.read(n):e.isQuanX&&(h=$prefs.valueForKey(n)),h=p(h),delete h[i];const o=JSON.stringify(h,null,4);f(n,o)}else{if(e.isStorm)return $persistentStore.remove(n);if(e.isSurgeLike)return $persistentStore.write(null,n);if(e.isQuanX)return $prefs.removeValueForKey(n)}t.debug(`DELETE KEY [${n}]${i?`[${i}]`:""}`)},update:(n,i,d,h=s,o=null)=>{if(i=u(i),h(l(n,null,d,!1,o),i)===!0)return!1;{const a=f(n,i,d,o);let _=l(n,null,d,!1,o);return h===s&&typeof _=="object"?a:h(i,_)}},allSessions:(n,i=null)=>{let d={},h=l(n,null,null,!0,i);return h=p(h),h.magic_session===!0&&(d={...h},delete d.magic_session),t.debug(`READ ALL SESSIONS [${n}] <${typeof d}>
${JSON.stringify(d,null,4)}`),d},allSessionNames:(n,i=null)=>{let d=[],h=l(n,null,null,!0,i);return h=p(h),d=h.magic_session!==!0?[]:Object.keys(h).filter((o=>o!=="magic_session")),t.debug(`READ ALL SESSIONS [${n}] <${typeof d}>
${JSON.stringify(d,null,4)}`),d},defaultValueComparator:s,convertToObject:p}}function MagicHttp(e,t){let r;e.isNode&&(r=require("axios").create());class s{constructor(a=!0){this.handlers=[],this.isRequest=a}use(a,_,S){return typeof a=="function"&&t.debug(`Register fulfilled ${a.name}`),typeof _=="function"&&t.debug(`Register rejected ${_.name}`),this.handlers.push({fulfilled:a,rejected:_,synchronous:!(!S||typeof S.synchronous!="boolean")&&S.synchronous,runWhen:S?S.runWhen:null}),this.handlers.length-1}eject(a){this.handlers[a]&&(this.handlers[a]=null)}forEach(a){this.handlers.forEach((_=>{_!==null&&a(_)}))}}function u(o){let a={...o};if(a.params&&!e.isNode){let _=Object.keys(a.params).map((S=>{const k=encodeURIComponent(S);return a.url=a.url.replace(new RegExp(`${S}=[^&]*`,"ig"),""),a.url=a.url.replace(new RegExp(`${k}=[^&]*`,"ig"),""),`${k}=${encodeURIComponent(a.params[S])}`})).join("&");a.url.indexOf("?")<0&&(a.url+="?"),/(&|\?)$/g.test(a.url)||(a.url+="&"),a.url+=_,delete a.params,t.debug(`Params to QueryString: ${a.url}`)}return a}const c=(o,a=null)=>{if(o){let _={...o,config:o.config||a,status:o.statusCode||o.status,body:o.body||o.data,headers:o.headers||o.header};if(typeof _.body=="string")try{_.body=JSON.parse(_.body)}catch{}return delete _.data,_}return o},p=(o,a=null)=>{if(o&&o.status>=400)return t.debug(`Raise exception when status code is ${o.status}`),{name:"RequestException",message:`Request failed with status code ${o.status}`,config:a||o.config,response:o}},g={request:new s,response:new s(!1)};let l=[],f=[],n=!0;function i(o){return o=u(o),t.debug(`HTTP ${o.method.toUpperCase()}:
${JSON.stringify(o)}`),o}function d(o){try{o=o&&c(o),t.sniffer(`HTTP ${o.config.method.toUpperCase()}:
${JSON.stringify(o.config)}
STATUS CODE:
${o.status}
RESPONSE:
${typeof o.body=="object"?JSON.stringify(o.body):o.body}`);const a=p(o);return a?Promise.reject(a):o}catch(a){return t.error(a),o}}const h=(o,a)=>{let _,S;a=((m,b)=>{let y=typeof b=="object"?{headers:{},...b}:{url:b,headers:{}};if(y.method||(y.method=m),y=u(y),y.rewrite===!0&&(e.isSurge?(y.headers["X-Surge-Skip-Scripting"]=!1,delete y.rewrite):e.isQuanX&&(y.hints=!1,delete y.rewrite)),e.isSurgeLike){const v=y.headers["content-type"]||y.headers["Content-Type"];y.method!=="GET"&&v&&v.indexOf("application/json")>=0&&y.body instanceof Array&&(y.body=JSON.stringify(y.body),t.debug(`Convert Array object to String: ${y.body}`))}else e.isQuanX?(y.hasOwnProperty("body")&&typeof y.body!="string"&&(y.body=JSON.stringify(y.body)),y.method=m):e.isNode&&(m==="POST"||m==="PUT"||m==="PATCH"||m==="DELETE"?y.data=y.data||y.body:m==="GET"&&(y.params=y.params||y.body),delete y.body);return y})(o.toUpperCase(),a),_=e.isNode?r:e.isSurgeLike?m=>new Promise(((b,y)=>{$httpClient[o.toLowerCase()](m,((v,O,T)=>{if(v){let E={name:v.name||v,message:v.message||v,stack:v.stack||v,config:m,response:c(O)};y(E)}else O.config=m,O.body=T,b(O)}))})):m=>new Promise(((b,y)=>{$task.fetch(m).then((v=>{v=c(v,m);const O=p(v,m);if(O)return Promise.reject(O);b(v)})).catch((v=>{let O={name:v.message||v.error,message:v.message||v.error,stack:v.error,config:m,response:v.response?c(v.response):null};y(O)}))})),(m=>{try{l=[],f=[],g.request.forEach((b=>{typeof b.runWhen=="function"&&b.runWhen(m)===!1||(n=n&&b.synchronous,l.unshift(b.fulfilled,b.rejected))})),g.response.forEach((b=>{f.push(b.fulfilled,b.rejected)}))}catch(b){t.error(`Failed to register interceptors: ${b}.`)}})(a);const k=[i,void 0],N=[d,void 0];if(n){for(t.debug("Interceptors are executed in synchronous mode"),Array.prototype.unshift.apply(l,k),l=l.concat([i,void 0]);l.length;){let m=l.shift(),b=l.shift();try{typeof m=="function"&&t.debug(`Executing request fulfilled ${m.name}`),a=m(a)}catch(y){typeof b=="function"&&t.debug(`Executing request rejected ${b.name}`),b(y);break}}try{S=!e.isNode&&a.timeout?w(a):_(a)}catch(m){return Promise.reject(m)}for(Array.prototype.unshift.apply(f,N);f.length;)S=S.then(f.shift(),f.shift());return S}{t.debug("Interceptors are executed in asynchronous mode");let m=[_,void 0];for(Array.prototype.unshift.apply(m,k),Array.prototype.unshift.apply(m,l),m=m.concat(N),m=m.concat(f),S=Promise.resolve(a);m.length;)try{let b=m.shift(),y=m.shift();!e.isNode&&a.timeout&&b===_&&(b=w),typeof b=="function"&&t.debug(`Executing request fulfilled ${b.name}`),typeof y=="function"&&t.debug(`Executing request rejected ${y.name}`),S=S.then(b,y)}catch(b){t.error(`request exception: ${b}`)}return S}function w(m){try{const b=new Promise(((y,v)=>{setTimeout((()=>{let O={message:`timeout of ${m.timeout}ms exceeded.`,config:m};v(O)}),m.timeout)}));return Promise.race([_(m),b])}catch(b){t.error(`Request Timeout exception: ${b}.`)}}};return{request:h,interceptors:g,convertHeadersToLowerCase:o=>Object.keys(o).reduce(((a,_)=>(a[_.toLowerCase()]=o[_],a)),{}),convertHeadersToCamelCase:o=>Object.keys(o).reduce(((a,_)=>(a[_.split("-").map((S=>S[0].toUpperCase()+S.slice(1))).join("-")]=o[_],a)),{}),modifyResponse:c,get:o=>h("GET",o),post:o=>h("POST",o),put:o=>h("PUT",o),patch:o=>h("PATCH",o),delete:o=>h("DELETE",o),head:o=>h("HEAD",o),options:o=>h("OPTIONS",o)}}(async()=>{let e=null;$.isResponse?e=await handleRequest("resp_handlers"):$.isRequest?e=await handleRequest("req_handlers"):($.data.del(currentUserInfoKey),$.data.del(blockedUsersKey),$.data.del(keywordBlockKey),$.notification.post("\u54F2\u4E5F\u540C\u5B66\u6570\u636E\u6E05\u7406\u5B8C\u6BD5")),e?$.done(e):$.done()})();
